#!/bin/bash
#####################
#COMMON
#####################
curl -Lo bin/protoc.zip https://github.com/protocolbuffers/protobuf/releases/download/v25.3/protoc-25.3-linux-x86_64.zip
cd bin && unzip protoc.zip && cp bin/protoc . && rm -f bin/protoc && rmdir bin && cd .. 
curl -Lo bin/protoc-gen-grpc-web https://github.com/grpc/grpc-web/releases/download/1.5.0/protoc-gen-grpc-web-1.5.0-linux-x86_64
chmod +x bin/protoc-gen-grpc-web
curl -Lo bin/protobuf-javascript.zip https://github.com/protocolbuffers/protobuf-javascript/releases/download/v3.21.4/protobuf-javascript-3.21.4-linux-x86_64.zip
cd bin && unzip -j protobuf-javascript.zip "bin/protoc-gen-js" -d "./" && rm -f protobuf-javascript.zip && cd ..
curl -Lo bin/protoc-gen-kotlin-grpc.jar https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-kotlin/1.4.1/protoc-gen-grpc-kotlin-1.4.1-jdk8.jar
curl -Lo bin/protoc-gen-grpc-java https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-java/1.71.0/protoc-gen-grpc-java-1.71.0-linux-x86_64.exe
chmod +x bin/protoc-gen-grpc-java
#####################
#BAZEL-PRE
#####################
#bazel clean
bazel run //:build_gen -- --src=tigera
sed -i "s/\/\/google/@com_google_googleapis\/\/google/g" tigera/goldmane/v1/BUILD.bazel
bazel build @com_google_googleapis//google/api:client_proto

#######################
#PLUGINS
#######################

#SCALA
curl -Lo bin/scala.zip https://github.com/scalapb/ScalaPB/releases/download/v1.0.0-alpha.1/protoc-gen-scala-1.0.0-alpha.1-linux-x86_64.zip
cd bin && unzip scala.zip && rm -f scala.zip && cd ..

#DART
curl -Lo bin/dart.zip https://storage.googleapis.com/dart-archive/channels/stable/release/3.3.4/sdk/dartsdk-linux-x64-release.zip
cd bin && unzip dart.zip && dart-sdk/bin/dart --disable-analytics pub global activate protoc_plugin && cd ..

#PYTHON
bazel build @com_github_grpc_grpc//src/compiler:grpc_python_plugin
cp bazel-bin/external/com_github_grpc_grpc/src/compiler/grpc_python_plugin bin/

#CSHARP
bazel build @com_github_grpc_grpc//src/compiler:grpc_csharp_plugin
cp bazel-bin/external/com_github_grpc_grpc/src/compiler/grpc_csharp_plugin bin/protoc-gen-grpc_csharp

#GO

## protoc-gen-go
# The protoc-gen-go binary is a protoc plugin to generate a Go protocol buffer package.
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
cp "$(go env GOPATH)/bin/protoc-gen-go" bin/

## protoc-gen-go-grpc
# This tool generates Go language bindings of `service`s in protobuf definition
# files for gRPC.  For usage information, please see our [quick start
# guide](https://grpc.io/docs/languages/go/quickstart/).
## Future-proofing services
# By default, to register services using the methods generated by this tool, the
# service implementations must embed the corresponding
# `Unimplemented<ServiceName>Server` for future compatibility.  This is a behavior
# change from the grpc code generator previously included with `protoc-gen-go`.
# To restore this behavior, set the option `require_unimplemented_servers=false`.
# E.g.:
# ```
#   protoc --go-grpc_out=. --go-grpc_opt=require_unimplemented_servers=false[,other options...] \
# ```
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
cp "$(go env GOPATH)/bin/protoc-gen-go-grpc" bin/

#PHP+GRPC
bazel build @com_github_grpc_grpc//src/compiler:grpc_php_plugin
cp bazel-bin/external/com_github_grpc_grpc/src/compiler/grpc_php_plugin bin/

#grpc-web
curl -Lo bin/protoc-gen-grpc-web https://github.com/grpc/grpc-web/releases/download/1.5.0/protoc-gen-grpc-web-1.5.0-linux-x86_64
chmod +x bin/protoc-gen-grpc-web

#######################
#TRANSITIONARY BUILDS
#######################
bazel build //tigera/goldmane/v1:goldmane_proto_with_info
bazel build //tigera/goldmane/v1:goldmane_proto_with_info

#####################
#KOTLIN/JAVA
#####################
mkdir -p src/java/stubs src/kotlin/stubs
bin/protoc -I=bazel-${PWD##*/}/external/com_google_googleapis \
            -I . -I=tigera/goldmane/v1/ \
            tigera/goldmane/v1/flows_service.proto \
            tigera/goldmane/v1/statistics_service.proto \
            tigera/goldmane/v1/flowcollector_service.proto \
            tigera/goldmane/v1/goldmane.proto \
            --java_out=src/java/stubs \
            --kotlin_out=src/kotlin/stubs \
            --plugin=protoc-gen-grpckt=bin/kotlin-grpc.sh \
            --grpckt_out=src/kotlin \
            --plugin=protoc-gen-grpc-java=bin/protoc-gen-grpc-java \
            --grpc-java_out=src/java

#####################
#GO
#####################
mkdir -p src/go/gapic

bin/protoc -I=bazel-${PWD##*/}/external/com_google_googleapis \
           -I . -I=tigera/goldmane/v1/ \
            tigera/goldmane/v1/flows_service.proto \
            tigera/goldmane/v1/statistics_service.proto \
            tigera/goldmane/v1/flowcollector_service.proto \
            tigera/goldmane/v1/goldmane.proto \
           --go_out=src/go \
           --go_opt=paths=source_relative \
           --go-grpc_out=src/go \
           --go_opt=paths=source_relative \
           --go-grpc_opt=paths=source_relative \
           --plugin=protoc-gen-go=bin/protoc-gen-go \
           --plugin=protoc-gen-go-grpc=bin/protoc-gen-go-grpc

#####################
#PHP
#####################
mkdir -p src/php/stubs

bin/protoc -I=bazel-${PWD##*/}/external/com_google_googleapis \
            -I . -I=tigera/goldmane/v1/ \
            tigera/goldmane/v1/flows_service.proto \
            tigera/goldmane/v1/statistics_service.proto \
            tigera/goldmane/v1/flowcollector_service.proto \
            tigera/goldmane/v1/goldmane.proto \
            --grpc_out=generate_server:src/php/stubs \
            --php_out=src/php/stubs \
            --plugin=protoc-gen-grpc=bin/grpc_php_plugin

#####################
#DART
#####################
mkdir -p src/dart
PATH=bin/dart-sdk/bin:$PATH bin/protoc -I=bazel-${PWD##*/}/external/com_google_googleapis \
            -I . -I=tigera/goldmane/v1/ \
            tigera/goldmane/v1/flows_service.proto \
            tigera/goldmane/v1/statistics_service.proto \
            tigera/goldmane/v1/flowcollector_service.proto \
            tigera/goldmane/v1/goldmane.proto \
            --dart_out=grpc:src/dart \
            --plugin=protoc-gen-dart=$HOME/.pub-cache/bin/protoc-gen-dart

#####################
#SCALA
#####################
mkdir -p src/scala/src/main/scala/
if [ ! -f src/scala/build.sbt ]; then
  cp tigera/build.sbt src/scala/;
fi;
PATH=bin/:$PATH bin/protoc -I=bazel-${PWD##*/}/external/com_google_googleapis \
            -I . -I=tigera/goldmane/v1/ \
            tigera/goldmane/v1/flows_service.proto \
            tigera/goldmane/v1/statistics_service.proto \
            tigera/goldmane/v1/flowcollector_service.proto \
            tigera/goldmane/v1/goldmane.proto \
            --scala_out=grpc:src/scala/src/main/scala/ \
            --plugin=protoc-gen-scala=bin/protoc-gen-scala

#####################
#PYTHON
#####################
mkdir -p src/python/code src/python/stubs
bin/protoc -I=bazel-${PWD##*/}/external/com_google_googleapis \
            -I . -I=tigera/goldmane/v1/ \
            tigera/goldmane/v1/flows_service.proto \
            tigera/goldmane/v1/statistics_service.proto \
            tigera/goldmane/v1/flowcollector_service.proto \
            tigera/goldmane/v1/goldmane.proto \
            --grpc_python_out=src/python/code \
            --python_out=src/python/code \
            --pyi_out=src/python/stubs \
            --plugin=protoc-gen-grpc_python=bin/grpc_python_plugin
            
#####################
#CSHARP
#####################
mkdir -p src/csharp/code
bin/protoc -I=bazel-${PWD##*/}/external/com_google_googleapis \
            -I . -I=tigera/goldmane/v1/ \
            tigera/goldmane/v1/flows_service.proto \
            tigera/goldmane/v1/statistics_service.proto \
            tigera/goldmane/v1/flowcollector_service.proto \
            tigera/goldmane/v1/goldmane.proto \
            --csharp_out=src/csharp/code \
            --grpc_csharp_out=src/csharp/code \
            --plugin=protoc-gen-grpc_csharp=bin/protoc-gen-grpc_csharp

#####################
#GRPC-WEB
#####################
#
mkdir -p src/js
bin/protoc -I=bazel-${PWD##*/}/external/com_google_googleapis \
            -I . -I=tigera/goldmane/v1/ \
            tigera/goldmane/v1/flows_service.proto \
            tigera/goldmane/v1/statistics_service.proto \
            tigera/goldmane/v1/flowcollector_service.proto \
            tigera/goldmane/v1/goldmane.proto \
            --js_out=import_style=commonjs:src/js \
            --grpc-web_out=import_style=commonjs,mode=grpcwebtext:src/js \
            --plugin=protoc-gen-grpc-web=bin/protoc-gen-grpc-web \
            --plugin=protoc-gen-js=bin/protoc-gen-js

#####################
#CLEAN
#####################
rm -rf bin/include
rm -f bin/protoc
rm -f bin/grpc_*_plugin
rm -f bin/protoc-gen-*
rm -f bin/protoc.zip
rm -f bin/readme.txt
rm -f bin/dartsdk-linux-x64-release.zip
rm -rf bin/dart-sdk $HOME/.pub-cache
rm -f bin/dart.zip
rm -f bin/scala.zip
